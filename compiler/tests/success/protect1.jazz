export fn foo (reg u64 i) -> reg u64 {
  stack u64[1] p;
  stack u64 si;
  reg u64 ms;
  reg u64 r;
  reg bool b;

  /* init miss-speculation flag / mask to 0 (ie no miss-speculation)
     This correspond to the sequence 
     LFENCE;
     ms = 0;  
  */
  ms = #init_msf();

  p[0] = 1;
  si = i; // spill i into si
  b = i == 0;
  if (b) {
     ms = #set_msf(b, ms);
     i = si;
     i = #protect(i, ms);
     r = p[(int)i];
  } else {
     ms = #set_msf(!b, ms);
     r = p[0];
  }
  ? #LFENCE;
  return r;
}